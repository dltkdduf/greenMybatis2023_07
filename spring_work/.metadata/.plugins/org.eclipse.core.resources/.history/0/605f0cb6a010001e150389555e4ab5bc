package com.example.demo.control;

import java.io.File;
import java.io.FileOutputStream;
import java.util.regex.Pattern;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.multipart.MultipartFile;

import com.example.demo.model.Member;

import jakarta.servlet.http.HttpServletRequest;

@Controller
public class MemberJoinController {

	@RequestMapping(value = "file/join", method = RequestMethod.GET)
	public String joinForm() {
		return "file/joinForm";
	}
	
	@RequestMapping(value = "file/join", method = RequestMethod.POST)
	public String joinSubmit(Member mm,HttpServletRequest request) {
		
		String res = "file/alert";
		
		if(mm.getImg().getContentType().startsWith("image/") &&
				Pattern.matches(".{1,}\\.(docx|txt|hwp)", mm.getResume().getOriginalFilename())
				) {
			res = "file/joinReg";
		}
		mm.setImgName(fileSave(mm.getImg(), request));
		mm.setResumeName(fileSave(mm.getResume(), request));
		System.out.println("가입처리:"+mm);
		
		return res;
	}
	
	String fileSave(MultipartFile mf, HttpServletRequest request) {
		String path = request.getServletContext().getRealPath("qwer")+"\\";
		String res = mf.getOriginalFilename();
		File ff = new File(path+res);
		int pos = res.lastIndexOf("\\.");
		String fName = res.substring(0,pos);
		String ext = res.substring(pos);
		int  no = 0;
		while(ff.exists()) {
			no++;
			res = fName+no+ext;
			ff = new File(path+res);
		}
		
		try {
			FileOutputStream fos = new FileOutputStream(ff);
			
			fos.write(mf.getBytes());
			fos.close();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		return res;
	}
	
}
